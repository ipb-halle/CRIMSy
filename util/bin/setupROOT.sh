#!/bin/bash
#
# Cloud Resource & Information Management System (CRIMSy)
# Superuser Setup
#
# Copyright 2020 Leibniz-Institut f. Pflanzenbiochemie 
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#
# Perform all the setup steps which require elevated privileges
#
#==========================================================
#
#

#
# Inserts a MAILTO directive
#
function editCronMAILTO {
    ed $TMP_CRONTAB <<EOF
0i
#
MAILTO=""
#
.
w
q
EOF
}

#
# installs or updates the LBAC cron entries
#
function editCronTab {
    ed $TMP_CRONTAB <<EOF
$CRON_ED_CMD
# LBAC CRON BEGIN
# Cron settings for CRIMSy
# do not edit unless you know what you're doing
#
#Min Hour Day Month Week Cmd
13 * * * * "$LBAC_DATASTORE/dist/bin/update.sh" proxy 2>/dev/null > /dev/null
17 10 * * * "$LBAC_DATASTORE/dist/bin/update.sh" log 2>/dev/null > /dev/null
5 4 * * 1 "$LBAC_DATASTORE/dist/bin/update.sh" container 2>/dev/null > /dev/null
8 1 * * * "$LBAC_DATASTORE/dist/bin/update.sh" backup 2>/dev/null > /dev/null
# LBAC CRON END
.
w
q
EOF

}

#
# Install or update crontab settings
#
function installCron {
    TMP_CRONTAB=`mktemp /tmp/crontab.XXXXXX`
    crontab -l > $TMP_CRONTAB

    CRON_MAILTO=0
    grep -q MAILTO $TMP_CRONTAB && CRON_MAILTO=1
    if [ $CRON_MAILTO -eq 0 ] ; then
        editCronMAILTO
    fi

    CRON_LBAC=0
    grep -q "LBAC CRON BEGIN" $TMP_CRONTAB && CRON_LBAC=1
    if [ $CRON_LBAC -eq 0 ] ; then
        # simply append to end
        CRON_ED_CMD='$a'
    else
        # replace block
        CRON_ED_CMD="/LBAC CRON BEGIN/,/LBAC CRON END/c"
    fi
    editCronTab
    cat $TMP_CRONTAB | crontab -u root -
    rm $TMP_CRONTAB
}


#
# Setup / install the init scripts
#
function installInit {
    case $LBAC_INIT_TYPE in
        SYSTEMD)
            installSystemd
            ;;
        SYSV)
            installSysVInit
            ;;
    esac
}

#
# provides permanent sudo access to unprivileged 
# installation account 
#
function installSudo {
    cat <<EOF > /etc/sudoers.d/lbac
#
# Sudo privilege for CRIMSy Managers
# -> allow password less sudo access
#
User_Alias LBAC_MANAGERS = $LBAC_USER
LBAC_MANAGERS ALL=(ALL) NOPASSWD: ALL
EOF
}

#
# Installs Init-Scripts
#
function installSystemd {
    cp "$LBAC_DATASTORE/dist/etc/lbac.service" /etc/systemd/system
    systemctl daemon-reload
    systemctl enable lbac.service
}

function installSysVInit {
cat << EOF > /etc/init.d/lbac
#!/bin/bash
#
# SysV init script generated by setup
# Copyright 2017 CRIMSy Team
#
### BEGIN INIT INFO
# Provides:       lbac
# Required-Start: docker
# Should-Start:   \$network \$syslog
# Required-Stop:  docker
# Should-Stop:    \$network \$syslog
# Default-Start:  3 5
# Default-Stop:   0 1 2 6
# Short-Description: CRIMSy 
# Description:    Run a Cloud Resource & Information Management System (CRIMSy) node 
### END INIT INFO
#

case \$1 in 
        start)
                "$LBAC_DATASTORE/dist/bin/lbacInit.sh" start
                ;;
        stop)
                "$LBAC_DATASTORE/dist/bin/lbacInit.sh" stop
                ;;
        *)
                echo "Usage: lbac {start|stop}"
                exit 1
                ;;
esac
EOF
        chmod +x  /etc/init.d/lbac
        insserv /etc/init.d/lbac
}

#
# remove containers
#
function removeFunc {
    "$LBAC_DATASTORE/dist/bin/lbacInit.sh" remove 
}

#
# persists installation directory for user root
#
function setInstallDir {
    echo "LBAC_DATASTORE=\"$LBAC_DATASTORE\"" > /root/.lbac
}

#
# shutdown
#
function shutdownFunc {
    case $LBAC_INIT_TYPE in
        SYSTEMD)
            systemctl stop lbac.service
            ;;
        SYSV)
            /etc/init.d/lbac stop
            ;;
    esac
}

#
#
#
function startFunc {
    case $LBAC_INIT_TYPE in
        SYSTEMD)
            systemctl start lbac.service
            ;;
        SYSV)
            /etc/init.d/lbac start
            ;;
    esac
}

#
#
#
function totalClean {
    pushd $LBAC_DATASTORE >/dev/null

    TMP_CRONTAB=`mktemp /tmp/crontab.XXXXXX`
    crontab -l > $TMP_CRONTAB
    cat << EOF | ed $TMP_CRONTAB
/LBAC CRON BEGIN/,/LBAC CRON END/d
w
q
EOF
    cat $TMP_CRONTAB | crontab -u root -
    rm $TMP_CRONTAB

    shutdownFunc
    sleep 15
    removeFunc
    rm -rf data/ dist/ etc/ tmp/ nodeconfig.cfg configBatch.sh

    popd > /dev/null
}

# 
#==========================================================
#
function error {
        echo $1
        exit 1
}
# 
#==========================================================
#
test `id -u` -eq 0 || (echo "setupROOT.sh: promoting to super user" && sudo $0 $@) || exit 1
test `id -u` -eq 0 || exit 0

if [ "$1" = "initROOT" ] ; then
        LBAC_DATASTORE=$2
        LBAC_USER=$3
        echo "Configuring LBAC_DATASTORE for root account: $LBAC_DATASTORE"
        setInstallDir
        echo "Setting up sudo privilege for user $LBAC_USER"
        installSudo $LBAC_USER
        exit
fi

. /root/.lbac || error "configuration missing: /root/.lbac"
. "$LBAC_DATASTORE/etc/config.sh" || error "configuration missing: LBAC_DATASTORE/etc/config.sh"

case $1 in
    installCron)
        echo "Setting up CRON"
        installCron
        ;;
    installInit)
        echo "Installing Init Script"
        installInit
        ;;
    remove)
        echo "Removing existing images"
        removeFunc
        ;;
    shutdown)
        echo "Shutting down containers"
        shutdownFunc
        ;;
    start)
        echo "Starting containers"
        startFunc
        ;;
    totalClean)
        echo "Cleaning totally"
        totalClean
        ;;
    *)
        error "setupROOT.sh called with invalid arguments"
        ;;
esac
echo "done"
