#!/bin/bash
#
# Cloud Resource & Information Management System (CRIMSy)
# Superuser Setup
#
# Copyright 2020 Leibniz-Institut f. Pflanzenbiochemie 
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#
# Perform all the setup steps which require elevated privileges
#
#==========================================================
#
# Global settings
#
BACKUP_AGE=4

#
#==========================================================
#
#

#
# Inserts a MAILTO directive
#
function editCronMAILTO {
    ed $TMP_CRONTAB <<EOF
0i
#
MAILTO=""
#
.
w
q
EOF
}

#
# installs or updates the LBAC cron entries
#
function editCronTab {
    ed $TMP_CRONTAB <<EOF
$CRON_ED_CMD
# LBAC CRON BEGIN
# Cron settings for CRIMSy
# do not edit unless you know what you're doing
#
#Min Hour Day Month Week Cmd
13 * * * * "$LBAC_DATASTORE/dist/bin/updateCloud.sh" update 2>/dev/null > /dev/null
8 1 * * * "$LBAC_DATASTORE/dist/bin/setupROOT.sh" backup 2>/dev/null > /dev/null
# LBAC CRON END
.
w
q
EOF

}

#
# Install or update crontab settings
#
function installCron {
    TMP_CRONTAB=`mktemp /tmp/crontab.XXXXXX`
    crontab -l > $TMP_CRONTAB

    CRON_MAILTO=0
    grep -q MAILTO $TMP_CRONTAB && CRON_MAILTO=1
    if [ $CRON_MAILTO -eq 0 ] ; then
        editCronMAILTO
    fi

    CRON_LBAC=0
    grep -q "LBAC CRON BEGIN" $TMP_CRONTAB && CRON_LBAC=1
    if [ $CRON_LBAC -eq 0 ] ; then
        # simply append to end
        CRON_ED_CMD='$a'
    else
        # replace block
        CRON_ED_CMD="/LBAC CRON BEGIN/,/LBAC CRON END/c"
    fi
    editCronTab
    cat $TMP_CRONTAB | crontab -u root -
    rm $TMP_CRONTAB
}


#
# Install a single additional CLOUD
# first step: copy certificates and truststores
#
function installCloudCert {
    pushd $LBAC_DATASTORE/dist/etc/$LBAC_CLOUD > /dev/null

    # add certificate and CRL to proxy 
    $LBAC_DATASTORE/dist/bin/updateCloud.sh cacrl

    # add certificate to truststore
    docker cp $LBAC_CLOUD.truststore dist_ui_1:/install
    docker cp $LBAC_CLOUD.trustpass dist_ui_1:/install
    docker cp $LBAC_CLOUD.pkcs12 dist_ui_1:/install
    docker cp $LBAC_CLOUD.keypass dist_ui_1:/install
}

#
# Install all CLOUDs
# second step: import certificates and SQL for _all_ clouds
#
function installClouds {
    pushd $LBAC_DATASTORE/dist/etc
    docker exec dist_ui_1 /usr/local/bin/importKeystores.sh

    # add database records
    docker cp clouds.sql dist_db_1:/tmp
    docker exec dist_db_1 /bin/bash -c \
      "cat /tmp/clouds.sql | su -c 'psql -Ulbac lbac' postgres && rm /tmp/clouds.sql"
}

#
# Setup / install the init scripts
#
function installInit {
    case $LBAC_INIT_TYPE in
        SYSTEMD)
            installSystemd
            ;;
        SYSV)
            installSysVInit
            ;;
    esac
}

#
# provides permanent sudo access to unprivileged 
# installation account 
#
function installSudo {
    cat <<EOF > /etc/sudoers.d/lbac
#
# Sudo privilege for CRIMSy Managers
# -> allow password less sudo access
#
User_Alias LBAC_MANAGERS = $LBAC_USER
LBAC_MANAGERS ALL=(ALL) NOPASSWD: ALL
EOF
}

#
# Installs Init-Scripts
#
function installSystemd() {
    cp "$LBAC_DATASTORE/dist/etc/lbac.service" /etc/systemd/system
    systemctl daemon-reload
    systemctl enable lbac.service
}

function installSysVInit() {
cat << EOF > /etc/init.d/lbac
#!/bin/bash
#
# SysV init script generated by setup
# Copyright 2017 CRIMSy Team
#
### BEGIN INIT INFO
# Provides:       lbac
# Required-Start: docker
# Should-Start:   \$network \$syslog
# Required-Stop:  docker
# Should-Stop:    \$network \$syslog
# Default-Start:  3 5
# Default-Stop:   0 1 2 6
# Short-Description: CRIMSy 
# Description:    Run a Cloud Resource & Information Management System (CRIMSy) node 
### END INIT INFO
#

case \$1 in 
        start)
                "$LBAC_DATASTORE/dist/bin/lbacInit.sh" start
                ;;
        stop)
                "$LBAC_DATASTORE/dist/bin/lbacInit.sh" stop
                ;;
        *)
                echo "Usage: lbac {start|stop}"
                exit 1
                ;;
esac
EOF
        chmod +x  /etc/init.d/lbac
        insserv /etc/init.d/lbac
}

#
# execute database migrations
#
function postInstall {
    "$LBAC_DATASTORE/dist/bin/lbacInit.sh" startService db

    echo "Waiting 15 sek. for database to come up ..."
    sleep 15

    docker exec -i dist_db_1 chown postgres /data/db
    docker exec -i -u postgres dist_db_1 /usr/local/bin/getversion.sh

    if [ -e "$LBAC_DATASTORE/tmp/OLD_PG_VERSION" ] ; then
        OLD_PG_VERSION=`cat "$LBAC_DATASTORE/tmp/OLD_PG_VERSION"`
        CURRENT_PG_VERSION=`cat "$LBAC_DATASTORE/data/db/CURRENT_PG_VERSION"`
        if [ $CURRENT_PG_VERSION != $OLD_PG_VERSION ] ; then 
            LABEL=latest
            restoreDB
        fi
    fi

    docker exec -i -u postgres dist_db_1 /usr/local/bin/dbupdate.sh
}

#
# remove containers
#
function removeFunc {
    "$LBAC_DATASTORE/dist/bin/lbacInit.sh" remove 
    docker rmi pgchem 2>/dev/null >/dev/null
}

#
# restore the entire system
#
function restoreFunc {
    "$LBAC_DATASTORE/dist/bin/lbacInit.sh" stopService ui

    pushd "$LBAC_DATASTORE/backup/ui" > /dev/null
    tar -C "$LBAC_DATASTORE/data" -xvf ui.$LABEL.tar.gz
    popd > /dev/null

    restoreDB

    "$LBAC_DATASTORE/dist/bin/lbacInit.sh" startService ui
}

#
# restore a database snapshot only
#
function restoreDB {
    echo "restoring database snapshot: $LABEL"
    cat "$LBAC_DATASTORE/backup/db/dump.$LABEL.sql" |\
        docker exec -i -u postgres dist_db_1 psql ||\
        error "Error during database restore"

    "$LBAC_DATASTORE/dist/bin/lbacInit.sh" restartService ui
}

#
# persists installation directory for user root
#
function setInstallDir {
    echo "LBAC_DATASTORE=\"$LBAC_DATASTORE\"" > /root/.lbac
}

#
# set UID for data directories
#
function setPermissions {
    chown 5432 "$LBAC_DATASTORE/data/db"
    chown 8080 "$LBAC_DATASTORE/data/ui"
}

#
# shutdown
#
function shutdownFunc {
    case $LBAC_INIT_TYPE in
        SYSTEMD)
            systemctl stop lbac.service
            ;;
        SYSV)
            /etc/init.d/lbac stop
            ;;
    esac
}

#
#
#
function snapshotCleanup {
        pushd "$LBAC_DATASTORE/backup" > /dev/null
        find db/ ui/ -type f -mtime +$BACKUP_AGE -exec rm {} \; 
        popd > /dev/null
}

#
#
#
function snapshotDB {
        mkdir -p "$LBAC_DATASTORE/backup/db"
        pushd "$LBAC_DATASTORE/backup/db" > /dev/null
        rm -f dump.latest.sql
        docker exec dist_db_1 pg_dump --create --clean --if-exists \
          -U lbac > "$LBAC_DATASTORE/backup/db/dump.$LABEL.sql" || \
          error "Error during database dump"
        ln -s dump.$LABEL.sql dump.latest.sql
        popd > /dev/null
}

#
# snapshot
#
function snapshotFunc {
    "$LBAC_DATASTORE/dist/bin/lbacInit.sh" startService db
    snapshotDB
    snapshotUI
    snapshotCleanup
    docker exec -i -u postgres dist_db_1 /usr/local/bin/getversion.sh
    cp "$LBAC_DATASTORE/data/db/CURRENT_PG_VERSION" "$LBAC_DATASTORE/tmp/OLD_PG_VERSION"
}

#
#
#
function snapshotUI {
        mkdir -p "$LBAC_DATASTORE/backup/ui"
        pushd "$LBAC_DATASTORE/backup/ui" > /dev/null
        rm -f ui.latest.tar.gz
        tar -C "$LBAC_DATASTORE/data" -czf ui.$LABEL.tar.gz ui
        ln -s ui.$LABEL.tar.gz ui.latest.tar.gz
        popd > /dev/null
}

#
#
#
function startFunc {
    case $LBAC_INIT_TYPE in
        SYSTEMD)
            systemctl start lbac.service
            ;;
        SYSV)
            /etc/init.d/lbac start
            ;;
    esac
}

#
#
#
function totalClean {
    pushd $LBAC_DATASTORE >/dev/null

    TMP_CRONTAB=`mktemp /tmp/crontab.XXXXXX`
    crontab -l > $TMP_CRONTAB
    cat << EOF | ed $TMP_CRONTAB
/LBAC CRON BEGIN/,/LBAC CRON END/d
w
q
EOF
    cat $TMP_CRONTAB | crontab -u root -
    rm $TMP_CRONTAB

    shutdownFunc
    sleep 15
    removeFunc
    rm -rf data/ dist/ etc/ tmp/ nodeconfig.txt configBatch.sh

    popd > /dev/null
}

# 
#==========================================================
#
function error {
        echo $1
        exit 1
}
# 
#==========================================================
#
test `id -u` -eq 0 || (echo "setupROOT.sh: promoting to super user" && sudo $0 $@) || exit 1
test `id -u` -eq 0 || exit 0

if [ "$1" = "initROOT" ] ; then
        LBAC_DATASTORE=$2
        LBAC_USER=$3
        echo "Configuring LBAC_DATASTORE for root account: $LBAC_DATASTORE"
        setInstallDir
        echo "Setting up sudo privilege for user $LBAC_USER"
        installSudo $LBAC_USER
        exit
fi

. /root/.lbac || error "configuration missing: /root/.lbac"
. "$LBAC_DATASTORE/dist/etc/config.sh" || error "configuration missing: LBAC_DATASTORE/dist/etc/config.sh"

case $1 in
    backup)
        LABEL=`date "+%Y%m%d%H%M"`
        snapshotFunc
        ;;
    installCron)
        echo "Setting up CRON"
        installCron
        ;;
    installCloudCert)
        LBAC_CLOUD=$2
        echo "Installing cloud: $LBAC_CLOUD"
        installCloudCert
        ;;
    installClouds)
        echo "Activate all clouds"
        installClouds
        ;;
    installInit)
        echo "Installing Init Script"
        installInit
        ;;
    postInstall)
        echo "Running post-install tasks"
        postInstall
        ;;
    remove)
        echo "Removing existing images"
        removeFunc
        ;;
    restore)
        echo "restoring snapshot"
        LABEL=$2
        restoreFunc
        ;;
    restoreDB)
        echo "restoring database snapshot"
        LABEL=$2
        restoreDB
        ;;
    setPermissions)
        echo "Setting directory permissions"
        setPermissions
        ;;
    shutdown)
        echo "Shutting down containers"
        shutdownFunc
        ;;
    snapshot)
        echo "Taking snapshot"
        LABEL=$2
        snapshotFunc
        ;;
    start)
        echo "Starting containers"
        startFunc
        ;;
    totalClean)
        echo "Cleaning totally"
        totalClean
        ;;
    *)
        error "setupROOT.sh called with invalid arguments"
        ;;
esac
echo "done"
